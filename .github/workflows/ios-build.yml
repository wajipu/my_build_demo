name: iOS Build

on:
  push:
    branches:
      - main
      - master
  pull_request:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Set up signing
        shell: bash
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          IOS_MOBILEPROVISION_BASE64: ${{ secrets.IOS_MOBILEPROVISION_BASE64 }}
          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
          IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
          IOS_PROFILE_NAME: ${{ secrets.IOS_PROFILE_NAME }}
        run: |
          set -euo pipefail
          KEYCHAIN_PASSWORD="$(uuidgen)"
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain

          python3 - <<'PY'
          import base64, os, sys
          data = os.environ["IOS_P12_BASE64"]
          data = data.replace("\r", "").replace("\n", "")
          try:
              raw = base64.b64decode(data, validate=True)
          except Exception as e:
              print("IOS_P12_BASE64 is not valid base64:", e, file=sys.stderr)
              sys.exit(1)
          if len(raw) < 1000 or raw[:1] != b"\x30":
              print("IOS_P12_BASE64 decoded data does not look like a PKCS#12 file.", file=sys.stderr)
              sys.exit(1)
          open("signing.p12", "wb").write(raw)
          PY
          file signing.p12
          openssl pkcs12 -in signing.p12 -passin pass:"$IOS_P12_PASSWORD" -nokeys -info | head -n 20
          security import signing.p12 -k build.keychain -P "$IOS_P12_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security list-keychain -d user -s build.keychain
          security find-identity -v -p codesigning build.keychain || true

          python3 - <<'PY'
          import base64, os, sys
          data = os.environ["IOS_MOBILEPROVISION_BASE64"]
          data = data.replace("\r", "").replace("\n", "")
          try:
              raw = base64.b64decode(data, validate=True)
          except Exception as e:
              print("IOS_MOBILEPROVISION_BASE64 is not valid base64:", e, file=sys.stderr)
              sys.exit(1)
          open("profile.mobileprovision", "wb").write(raw)
          PY
          security cms -D -i profile.mobileprovision > profile.plist
          /usr/libexec/PlistBuddy -c "Print :Name" profile.plist
          /usr/libexec/PlistBuddy -c "Print :TeamIdentifier:0" profile.plist
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c "Print :UUID" profile.plist)
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$PROFILE_UUID.mobileprovision

          cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>ad-hoc</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>${IOS_TEAM_ID}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${IOS_BUNDLE_ID}</key>
              <string>${IOS_PROFILE_NAME}</string>
            </dict>
          </dict>
          </plist>
          EOF

      - name: Build IPA (release)
        shell: bash
        env:
          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
          IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
          IOS_PROFILE_NAME: ${{ secrets.IOS_PROFILE_NAME }}
        run: |
          set -euo pipefail
          xcodebuild \
            -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath build/ios/archive/Runner.xcarchive \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            DEVELOPMENT_TEAM="$IOS_TEAM_ID" \
            PROVISIONING_PROFILE_SPECIFIER="$IOS_PROFILE_NAME" \
            PRODUCT_BUNDLE_IDENTIFIER="$IOS_BUNDLE_ID" \
            clean archive

          xcodebuild \
            -exportArchive \
            -archivePath build/ios/archive/Runner.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath build/ios/ipa

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/ios/ipa/*.ipa
